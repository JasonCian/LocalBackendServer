<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PowerShell å‘½ä»¤å†å²ç®¡ç† Â· æœ¬åœ°è½»é‡çº§åç«¯</title>
  <link rel="stylesheet" href="/css/powershell-history.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ–¥ï¸ PowerShell å‘½ä»¤å†å²ç®¡ç†</h1>
      <p class="subtitle">éšç§ä¿æŠ¤ Â· å»é‡ä¼˜åŒ– Â· å¿«æ·æŒ‡ä»¤ç®¡ç†</p>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ä»ªè¡¨ç›˜</button>
      <button class="tab" onclick="switchTab('history')">ğŸ“œ å†å²æŸ¥çœ‹</button>
      <button class="tab" onclick="switchTab('rules')">âš™ï¸ è¿‡æ»¤è§„åˆ™</button>
      <button class="tab" onclick="switchTab('shortcuts')">âš¡ å¿«æ·æŒ‡ä»¤</button>
    </div>

    <!-- ä»ªè¡¨ç›˜ -->
    <div id="tab-dashboard" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">æ€»å‘½ä»¤æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-records">-</div>
          <div class="stat-label">å·²è®°å½•</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value" id="stat-masked">-</div>
          <div class="stat-label">å·²æ©ç›–</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-shortcuts">-</div>
          <div class="stat-label">å¿«æ·æŒ‡ä»¤</div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ”¥ çƒ­é—¨å¿«æ·æŒ‡ä»¤</h2>
        <div id="top-shortcuts" class="shortcuts-simple-list">
          <div class="empty">æš‚æ— æ•°æ®</div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“‹ è§„åˆ™çŠ¶æ€</h2>
        <div id="rules-status" class="rules-simple-list">
          <div class="empty">æš‚æ— è§„åˆ™</div>
        </div>
      </div>

      <div class="card">
        <button onclick="cleanHistory()" class="btn-primary btn-large">
          ğŸ§¹ ç«‹å³æ¸…ç†å†å²
        </button>
        <p class="hint">å°†åº”ç”¨æ‰€æœ‰è¿‡æ»¤è§„åˆ™æ¸…ç†PowerShellå†å²æ–‡ä»¶ï¼ˆæ“ä½œå‰ä¼šè‡ªåŠ¨å¤‡ä»½ï¼‰</p>
      </div>
    </div>

    <!-- å†å²æŸ¥çœ‹ -->
    <div id="tab-history" class="tab-content">
      <div class="card">
        <div class="toolbar">
          <input type="text" id="history-search" placeholder="æœç´¢å‘½ä»¤..." class="search-input" />
          <button onclick="loadHistory()">ğŸ”„ åˆ·æ–°</button>
          <label for="history-limit">æ˜¾ç¤ºæ•°é‡ï¼š</label>
          <select id="history-limit" onchange="loadHistory()">
            <option value="100">æœ€è¿‘100æ¡</option>
            <option value="500">æœ€è¿‘500æ¡</option>
            <option value="1000">æœ€è¿‘1000æ¡</option>
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div id="history-list" class="history-list">
          <div class="empty">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- è¿‡æ»¤è§„åˆ™ -->
    <div id="tab-rules" class="tab-content">
      <div class="card">
        <h2>âš¡ å¿«é€Ÿé¢„è®¾</h2>
        <p class="subtitle">ä¸€é”®æ·»åŠ å¸¸è§éšç§è§„åˆ™ï¼Œæ— éœ€å¤æ‚é…ç½®</p>
        <div class="preset-buttons">
          <button onclick="addPresetRule('password')" class="preset-btn">ğŸ” å¯†ç /Token</button>
          <button onclick="addPresetRule('email')" class="preset-btn">ğŸ“§ é‚®ç®±åœ°å€</button>
          <button onclick="addPresetRule('ip')" class="preset-btn">ğŸŒ IPåœ°å€</button>
          <button onclick="addPresetRule('ssh')" class="preset-btn">ğŸ”‘ SSH/RDPè¿æ¥</button>
          <button onclick="addPresetRule('apikey')" class="preset-btn">ğŸ« APIå¯†é’¥</button>
          <button onclick="addPresetRule('creditcard')" class="preset-btn">ğŸ’³ ä¿¡ç”¨å¡å·</button>
        </div>
      </div>

      <div class="card">
        <h2>â• è‡ªå®šä¹‰è§„åˆ™</h2>
        <p class="subtitle">é«˜çº§é€‰é¡¹ï¼šåˆ›å»ºè‡ªå·±çš„éšç§è§„åˆ™</p>
        <div class="form-grid form-grid-2col">
          <div class="form-row">
            <label for="rule-name">è§„åˆ™åç§°</label>
            <input type="text" id="rule-name" placeholder="ä¾‹: éšè—å†…ç½‘IP" />
          </div>
          <div class="form-row">
            <label for="rule-template">è¦æ©ç›–çš„å†…å®¹</label>
            <select id="rule-template">
              <option value="">-- è¯·é€‰æ‹©åŒ¹é…æ–¹å¼ --</option>
              <option value="keyword">å…³é”®å­—åŒ¹é…ï¼ˆç®€å•ï¼‰</option>
              <option value="pattern">æ­£åˆ™è¡¨è¾¾å¼ï¼ˆé«˜çº§ï¼‰</option>
            </select>
          </div>
        </div>
        
        <!-- å…³é”®å­—åŒ¹é…æ¨¡å¼ -->
        <div id="keyword-mode">
          <div class="form-grid form-grid-2col">
            <div class="form-row form-row-span-all">
              <label for="rule-keywords">å…³é”®å­—ï¼ˆç”¨|åˆ†éš”å¤šä¸ªï¼‰</label>
              <input type="text" id="rule-keywords" placeholder="ä¾‹: password|passwd|pwd|secret" />
            </div>
            <div class="form-row">
              <label for="rule-keyword-type">åŒ¹é…æ–¹å¼</label>
              <select id="rule-keyword-type">
                <option value="whole">å®Œæ•´è¯åŒ¹é…</option>
                <option value="partial">åŒ…å«åŒ¹é…</option>
              </select>
            </div>
            <div class="form-row">
              <label for="rule-maskMode-keyword">æ©ç›–å¼ºåº¦</label>
              <select id="rule-maskMode-keyword">
                <option value="weak">å¼± - ç”¨ * ä¿ç•™ä½æ•°ï¼ˆpassword=***ï¼‰</option>
                <option value="strong" selected>å¼º - ç”¨ [MASKED] éšè—ï¼ˆpassword=[MASKED]ï¼‰</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- æ­£åˆ™æ¨¡å¼ -->
        <div id="regex-mode">
          <div class="form-grid form-grid-2col">
            <div class="form-row form-row-span-all">
              <label for="rule-pattern">æ­£åˆ™è¡¨è¾¾å¼</label>
              <input type="text" id="rule-pattern" placeholder="ä¾‹: (password)\s*[=:]\s*([^\s]+)" />
            </div>
            <div class="form-row">
              <label for="rule-target">æ©ç›–å“ªä¸€éƒ¨åˆ†</label>
              <select id="rule-target">
                <option value="0">æ•´ä¸ªåŒ¹é…éƒ¨åˆ†</option>
                <option value="1">ç¬¬1ä¸ªæ‹¬å·å†…å®¹</option>
                <option value="2">ç¬¬2ä¸ªæ‹¬å·å†…å®¹</option>
                <option value="3">ç¬¬3ä¸ªæ‹¬å·å†…å®¹</option>
              </select>
            </div>
            <div class="form-row">
              <label for="rule-maskMode">æ©ç›–å¼ºåº¦</label>
              <select id="rule-maskMode">
                <option value="weak">å¼± - ç”¨ * ä¿ç•™ä½æ•°ï¼ˆpassword=***ï¼‰</option>
                <option value="strong" selected>å¼º - ç”¨ [MASKED] éšè—ï¼ˆpassword=[MASKED]ï¼‰</option>
              </select>
            </div>
          </div>
          <div class="hint-box">
            ğŸ’¡ <strong>è¯´æ˜</strong>ï¼šæ­£åˆ™è¡¨è¾¾å¼ä¸­ç”¨ <code>()</code> æ‹¬å·æ ‡è®°éƒ¨åˆ†ã€‚æ©ç›–ç›®æ ‡é€‰æ‹©è¦éšè—çš„éƒ¨åˆ†ã€‚<br/>ä¾‹ï¼š<code>(password)\s*[=:]\s*([^\s]+)</code> æœ‰2ä¸ªæ‹¬å·ï¼Œé€‰æ‹©ç¬¬2ä¸ªå¯åªæ©ç›–å¯†ç å€¼
          </div>
        </div>
        
        <div class="buttons">
          <label class="checkbox-label">
            <input type="checkbox" id="rule-enabled" checked />
            <span>å¯ç”¨æ­¤è§„åˆ™</span>
          </label>
          <button onclick="addCustomRule()" class="btn-primary">âœ“ æ·»åŠ è‡ªå®šä¹‰è§„åˆ™</button>
        </div>
        <div class="status-box status-hidden" id="add-rule-status"></div>
      </div>

      <div class="card">
        <h2>âš™ï¸ è§„åˆ™åˆ—è¡¨</h2>
        <div id="rules-list" class="rules-list">
          <div class="empty">æš‚æ— è§„åˆ™</div>
        </div>
        <div class="card rule-legend">
          <h3>ğŸ“– æ©ç›–å¼ºåº¦è¯´æ˜</h3>
          <div class="legend-items">
            <div>
              <span class="badge info">å¼±æ©ç›–</span> ä¿ç•™å­—ç¬¦ä½æ•°ï¼Œç”¨ * æ›¿æ¢<br/>
              <code>password=secret123</code> â†’ <code>password=*************</code>
            </div>
            <div>
              <span class="badge primary">å¼ºæ©ç›–</span> ç”¨ [MASKED] æ›¿æ¢æ•´æ®µ<br/>
              <code>password=secret123</code> â†’ <code>password=[MASKED]</code>
            </div>
            <div>
              <span class="badge muted">æ©ç›–ç›®æ ‡</span> 0=æ•´ä¸ªæ­£åˆ™åŒ¹é…ï¼›1/2/...=æŒ‡å®šæ•è·åˆ†ç»„<br/>
              ä¾‹å¦‚ï¼šæ­£åˆ™ <code>(pwd)\s*=\s*([^\s]+)</code>ï¼Œæ©ç›–ç›®æ ‡=2 åªæ©ç›–å¯†ç å€¼éƒ¨åˆ†
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ§ª è§„åˆ™æµ‹è¯•</h2>
        <div class="form-grid">
          <div class="form-row">
            <label for="test-command">æµ‹è¯•å‘½ä»¤</label>
            <input type="text" id="test-command" placeholder="è¾“å…¥è¦æµ‹è¯•çš„å‘½ä»¤" />
          </div>
          <div class="form-row">
            <label for="test-rule-id">é€‰æ‹©è§„åˆ™</label>
            <select id="test-rule-id">
              <option value="">è¯·é€‰æ‹©è§„åˆ™</option>
            </select>
          </div>
        </div>
        <button onclick="testRule()">æµ‹è¯•</button>
        <div class="status-box status-hidden" id="test-result"></div>
      </div>
    </div>

    <!-- å¿«æ·æŒ‡ä»¤ -->
    <div id="tab-shortcuts" class="tab-content">
      <div class="card">
        <h2>âš¡ å¿«æ·æŒ‡ä»¤ï¼ˆç›´æ¥å†™å…¥å†å²ï¼‰</h2>
        <p class="subtitle">å°†å¸¸ç”¨æŒ‡ä»¤æ·»åŠ åˆ°PowerShellå†å²ï¼Œè¿™æ ·æ•²å¼€å¤´æ—¶å¯ä»¥ç”¨Tabè¡¥å…¨æ•´æ¡æŒ‡ä»¤</p>
        <div class="form-grid form-grid-2col">
          <div class="form-row">
            <label for="shortcut-command">PowerShellæŒ‡ä»¤</label>
            <input type="text" id="shortcut-command" placeholder="ä¾‹: git statusã€npm start ç­‰" />
          </div>
          <div class="form-row">
            <label for="shortcut-category">åˆ†ç±»</label>
            <input type="text" id="shortcut-category" placeholder="ä¾‹: git, npm, custom" />
          </div>
          <div class="form-row form-row-span-all">
            <label for="shortcut-description">æè¿°</label>
            <input type="text" id="shortcut-description" placeholder="ç®€çŸ­æè¿°æ­¤æŒ‡ä»¤çš„ä½œç”¨" />
          </div>
        </div>
        <div class="buttons">
          <button onclick="addShortcut()" class="btn-primary">æ·»åŠ åˆ°å†å²</button>
        </div>
        <div class="status-box status-hidden" id="add-shortcut-status"></div>
      </div>

      <div class="card">
        <div class="toolbar">
          <input type="text" id="shortcut-search" placeholder="æœç´¢å¿«æ·æŒ‡ä»¤..." class="search-input" oninput="searchShortcuts()" />
          <label for="shortcut-filter">åˆ†ç±»è¿‡æ»¤ï¼š</label>
          <select id="shortcut-filter" onchange="filterShortcuts()">
            <option value="">å…¨éƒ¨åˆ†ç±»</option>
          </select>
        </div>
        <div id="shortcuts-list" class="shortcuts-list">
          <div class="empty">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ä»å½“å‰é¡µé¢URLè·å–APIåŸºç¡€è·¯å¾„
    // å¦‚æœè®¿é—® /pshï¼Œåˆ™ API_BASE = /psh
    // å¦‚æœè®¿é—® /psh/ï¼Œåˆ™ API_BASE = /psh
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const API_BASE = pathParts.length > 0 ? '/' + pathParts[0] : '/powershell';
    
    let stats = null;
    let rules = [];
    let shortcuts = [];
    let categories = [];
    
    // è§„åˆ™é¢„è®¾åº“
    const rulePresets = {
      password: {
        name: 'éšè—å¯†ç /Token',
        pattern: '(password|passwd|pwd|secret|token|apikey|api_key|key)\\s*[=:\\s]+([^\\s\\r\\n]+)',
        maskMode: 'strong',
        maskGroup: 2,
        description: 'éšè—å¯†ç ã€Tokenã€APIå¯†é’¥ç­‰è®¤è¯ä¿¡æ¯ï¼ˆåªæ©ç›–å€¼éƒ¨åˆ†ï¼‰'
      },
      email: {
        name: 'éšè—é‚®ç®±åœ°å€',
        pattern: '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}',
        maskMode: 'weak',
        maskGroup: 0,
        description: 'éšè—é‚®ç®±åœ°å€ï¼Œä¿ç•™é•¿åº¦'
      },
      ip: {
        name: 'éšè—IPåœ°å€',
        pattern: '\\b(?:\\d{1,3}\\.){3}\\d{1,3}\\b',
        maskMode: 'weak',
        maskGroup: 0,
        description: 'éšè—IPv4åœ°å€ï¼Œä¿ç•™é•¿åº¦'
      },
      ssh: {
        name: 'éšè—SSH/RDPè¿æ¥ä¿¡æ¯',
        pattern: '(ssh|rdp|telnet|scp)\\s+(?:-[a-zA-Z0-9\\s]*)?([^\\s@]+@[^\\s:]+)',
        maskMode: 'strong',
        maskGroup: 2,
        description: 'éšè—SSH/RDPç”¨æˆ·åå’Œä¸»æœºä¿¡æ¯'
      },
      apikey: {
        name: 'éšè—APIå¯†é’¥',
        pattern: '(api[_-]?key|auth[_-]?token|bearer|authorization)\\s*[=:\\s]+([a-zA-Z0-9_\\-]{16,})',
        maskMode: 'strong',
        maskGroup: 2,
        description: 'éšè—APIå¯†é’¥å’Œè®¤è¯ä»¤ç‰Œ'
      },
      creditcard: {
        name: 'éšè—ä¿¡ç”¨å¡å·',
        pattern: '\\b(?:\\d{4}[-\\s]?){3}\\d{4}\\b',
        maskMode: 'strong',
        maskGroup: 0,
        description: 'éšè—ä¿¡ç”¨å¡å·'
      }
    };

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      const tabButtons = document.querySelectorAll('.tab');
      const tabOrder = ['dashboard', 'history', 'rules', 'shortcuts'];
      const tabIndex = tabOrder.indexOf(tab);
      if (tabIndex >= 0 && tabIndex < tabButtons.length) {
        tabButtons[tabIndex].classList.add('active');
      }
      
      document.getElementById(`tab-${tab}`).classList.add('active');
      
      if (tab === 'dashboard') loadStats();
      if (tab === 'history') loadHistory();
      if (tab === 'rules') loadRules();
      if (tab === 'shortcuts') loadShortcuts();
    }

    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/api/stats`);
        const data = await res.json();
        
        if (data.success) {
          stats = data.stats;
          
          // æ˜¾ç¤ºå†å²ç»Ÿè®¡
          if (stats.records) {
            document.getElementById('stat-total').textContent = stats.records.total || 0;
            document.getElementById('stat-records').textContent = stats.records.total || 0;
            document.getElementById('stat-masked').textContent = stats.records.masked_count || 0;
          }
          
          // å¿«æ·æŒ‡ä»¤ç»Ÿè®¡
          document.getElementById('stat-shortcuts').textContent = stats.quickCommands || 0;
          
          const topDiv = document.getElementById('top-shortcuts');
          if (stats.quickCommands && stats.quickCommands > 0) {
            topDiv.innerHTML = `<div class="shortcut-simple-item">å·²æ·»åŠ  <strong>${stats.quickCommands}</strong> ä¸ªå¿«æ·æŒ‡ä»¤åˆ°PowerShellå†å²</div>`;
          } else {
            topDiv.innerHTML = '<div class="empty">æš‚æ— å¿«æ·æŒ‡ä»¤</div>';
          }
          
          // è§„åˆ™ç»Ÿè®¡
          const rulesDiv = document.getElementById('rules-status');
          if (stats.rules && stats.rules > 0) {
            rulesDiv.innerHTML = `<div class="rule-simple-item">å·²é…ç½® <strong>${stats.rules}</strong> æ¡éšç§è§„åˆ™</div>`;
          } else {
            rulesDiv.innerHTML = '<div class="empty">æš‚æ— è§„åˆ™</div>';
          }
        }
      } catch (err) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', err);
      }
    }

    // åŠ è½½å†å²
    async function loadHistory() {
      try {
        const limit = document.getElementById('history-limit').value;
        const url = limit ? `${API_BASE}/api/history?limit=${limit}` : `${API_BASE}/api/history`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
          const searchTerm = document.getElementById('history-search').value.toLowerCase();
          let records = data.history || [];
          
          if (searchTerm) {
            records = records.filter(r => r.command.toLowerCase().includes(searchTerm));
          }
          
          const listDiv = document.getElementById('history-list');
          if (records.length === 0) {
            listDiv.innerHTML = '<div class="empty">æ— åŒ¹é…å‘½ä»¤</div>';
          } else {
            listDiv.innerHTML = records.reverse().map((record, idx) => {
              const statusBadge = {
                'normal': '<span class="badge">æ­£å¸¸</span>',
                'weak_masked': '<span class="badge info">å¼±æ©ç›–</span>',
                'strong_masked': '<span class="badge primary">å¼ºæ©ç›–</span>',
                'shortcut': '<span class="badge success">âš¡ å¿«æ·æŒ‡ä»¤</span>'
              }[record.status] || '';
              
              return `
              <div class="history-item ${['weak_masked', 'strong_masked'].includes(record.status) ? 'history-' + record.status : ''} ${record.status === 'shortcut' ? 'history-shortcut' : ''}">
                <div class="history-header">
                  <span class="history-index">#${records.length - idx}</span>
                  <code class="history-command ${record.status === 'shortcut' ? 'shortcut-cmd' : ''}">${escapeHtml(record.command)}</code>
                </div>
                <div class="history-meta">
                  <span class="history-time">${new Date(record.timestamp).toLocaleString('zh-CN')}</span>
                  ${statusBadge}
                  ${record.reason ? `<span class="history-reason">${escapeHtml(record.reason)}</span>` : ''}
                </div>
                <div class="history-actions">
                  ${record.status !== 'shortcut' ? `<button onclick="editHistoryRecord('${escapeAttr(record.id)}', '${escapeAttr(record.command)}')" class="btn-sm">âœï¸ ç¼–è¾‘</button>` : ''}
                  ${record.status !== 'shortcut' ? `<button onclick="addHistoryAsShortcut('${escapeAttr(record.command)}')" class="btn-sm" title="å°†æ­¤æŒ‡ä»¤ç™»è®°ä¸ºå¿«æ·æŒ‡ä»¤">âš¡ ç™»è®°ä¸ºå¿«æ·æŒ‡ä»¤</button>` : ''}
                  ${record.status !== 'shortcut' ? `<button onclick="deleteHistoryRecord('${escapeAttr(record.id)}')" class="btn-sm btn-danger">ğŸ—‘ï¸ åˆ é™¤</button>` : '<span class="shortcut-hint">å¿«æ·æŒ‡ä»¤ï¼ˆä¸å¯ç¼–è¾‘ï¼‰</span>'}
                </div>
              </div>
            `;
            }).join('');
          }
        }
      } catch (err) {
        console.error('åŠ è½½å†å²å¤±è´¥:', err);
        document.getElementById('history-list').innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
      }
    }

    // ç¼–è¾‘å†å²è®°å½•
    async function editHistoryRecord(id, currentCommand) {
      const newCommand = prompt('ç¼–è¾‘å‘½ä»¤:', currentCommand);
      if (newCommand === null || newCommand.trim() === '') return;
      
      try {
        const res = await fetch(`${API_BASE}/api/history/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: newCommand.trim() })
        });
        const data = await res.json();
        
        if (data.success) {
          await loadHistory();
        } else {
          alert('ç¼–è¾‘å¤±è´¥: ' + data.message);
        }
      } catch (err) {
        alert('é”™è¯¯: ' + err.message);
      }
    }

    // åˆ é™¤å†å²è®°å½•
    async function deleteHistoryRecord(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/history/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          await loadHistory();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + data.message);
        }
      } catch (err) {
        alert('é”™è¯¯: ' + err.message);
      }
    }

    // å°†å†å²è®°å½•ç™»è®°ä¸ºå¿«æ·æŒ‡ä»¤
    async function addHistoryAsShortcut(command) {
      // å¼¹å‡ºå¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥åˆ†ç±»å’Œæè¿°
      const category = prompt('è¾“å…¥å¿«æ·æŒ‡ä»¤åˆ†ç±»ï¼ˆä¾‹å¦‚: git, npm, dockerï¼‰:', 'custom') || 'custom';
      if (category === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      const description = prompt('è¾“å…¥å¿«æ·æŒ‡ä»¤æè¿°ï¼ˆå¯é€‰ï¼‰:', '') || '';
      
      try {
        const res = await fetch(`${API_BASE}/api/shortcuts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            command: command,
            category: category.trim(),
            description: description.trim()
          })
        });
        const data = await res.json();
        
        if (data.success) {
          alert('âœ“ å¿«æ·æŒ‡ä»¤å·²æ·»åŠ åˆ°PowerShellå†å²ï¼\nä¸‹æ¬¡å°±å¯ä»¥ç”¨Tabè¡¥å…¨ã€‚\n\næŒ‡ä»¤: ' + command + '\nåˆ†ç±»: ' + category);
          // åˆ·æ–°å†å²åˆ—è¡¨å’Œå¿«æ·æŒ‡ä»¤åˆ—è¡¨
          await loadHistory();
          if (document.getElementById('tab-shortcuts').classList.contains('active')) {
            await loadShortcuts();
          }
        } else {
          alert('æ·»åŠ å¤±è´¥: ' + data.message);
        }
      } catch (err) {
        alert('é”™è¯¯: ' + err.message);
      }
    }

    // æ¸…ç†å†å²
    async function cleanHistory() {
      if (!confirm('ç¡®è®¤æ¸…ç†å†å²ï¼Ÿ\n\nå°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n1. åº”ç”¨æ‰€æœ‰è¿‡æ»¤è§„åˆ™ï¼ˆæ©ç›–æ•æ„Ÿä¿¡æ¯ï¼‰\n2. å»é™¤é‡å¤æŒ‡ä»¤\n3. æ“ä½œå‰ä¼šè‡ªåŠ¨å¤‡ä»½\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/history/clean`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          const stats = data.cleanResult || {};
          const msg = `æ¸…ç†å®Œæˆï¼\n\nåŸå§‹: ${stats.original || 0} æ¡\næ¸…ç†å: ${stats.cleaned || 0} æ¡\nç§»é™¤: ${stats.removed || 0} æ¡\næ©ç›–: ${stats.masked || 0} æ¡`;
          alert(msg);
          loadStats();
          loadHistory();
        } else {
          alert('æ¸…ç†å¤±è´¥: ' + data.message);
        }
      } catch (err) {
        alert('æ¸…ç†å¤±è´¥: ' + err.message);
      }
    }

    // åŠ è½½è§„åˆ™
    async function loadRules() {
      try {
        const res = await fetch(`${API_BASE}/api/rules`);
        const data = await res.json();
        
        if (data.success) {
          rules = data.rules;
          
          const listDiv = document.getElementById('rules-list');
          if (rules.length === 0) {
            listDiv.innerHTML = '<div class="empty">æš‚æ— è§„åˆ™</div>';
          } else {
            listDiv.innerHTML = rules.map(r => `
              <div class="rule-item ${!r.enabled ? 'disabled' : ''}">
                <div class="rule-header">
                  <span class="rule-name">${escapeHtml(r.name)}</span>
                  <div class="rule-badges">
                    ${r.enabled ? `<span class="badge ${r.maskMode === 'weak' ? 'info' : 'primary'}">${r.maskMode === 'weak' ? 'å¼±' : 'å¼º'}</span>` : '<span class="badge muted">å·²ç¦ç”¨</span>'}
                    ${r.maskGroup > 0 ? `<span class="badge muted">åˆ†ç»„${r.maskGroup}</span>` : ''}
                  </div>
                </div>
                <div class="rule-pattern"><code>${escapeHtml(r.pattern)}</code></div>
                <div class="rule-actions">
                  <button onclick="toggleRule('${r.id}', ${!r.enabled})" class="btn-sm">${r.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                  <button onclick="deleteRule('${r.id}')" class="btn-sm btn-danger">åˆ é™¤</button>
                </div>
              </div>
            `).join('');
          }
          
          // æ›´æ–°æµ‹è¯•ä¸‹æ‹‰æ¡†
          const testSelect = document.getElementById('test-rule-id');
          testSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è§„åˆ™</option>' +
            rules.map(r => `<option value="${r.id}">${escapeHtml(r.name)}</option>`).join('');
        }
      } catch (err) {
        console.error('åŠ è½½è§„åˆ™å¤±è´¥:', err);
      }
    }

    // åˆ‡æ¢æ¨¡æ¿ï¼ˆå…³é”®å­—vsæ­£åˆ™ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      const templateSelect = document.getElementById('rule-template');
      if (templateSelect) {
        templateSelect.addEventListener('change', function(e) {
          const mode = e.target.value;
          const keywordDiv = document.getElementById('keyword-mode');
          const regexDiv = document.getElementById('regex-mode');
          
          if (mode === 'keyword') {
            keywordDiv.style.display = 'block';
            regexDiv.style.display = 'none';
          } else if (mode === 'pattern') {
            keywordDiv.style.display = 'none';
            regexDiv.style.display = 'block';
          } else {
            keywordDiv.style.display = 'none';
            regexDiv.style.display = 'block';
          }
        });
      }
    });
    
    // æ·»åŠ é¢„è®¾è§„åˆ™
    async function addPresetRule(presetKey) {
      const preset = rulePresets[presetKey];
      if (!preset) {
        alert('é¢„è®¾è§„åˆ™ä¸å­˜åœ¨');
        return;
      }
      
      showStatus('add-rule-status', 'æ·»åŠ ä¸­...', 'loading');
      try {
        const res = await fetch(`${API_BASE}/api/rules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: preset.name,
            pattern: preset.pattern,
            action: 'mask',
            maskMode: preset.maskMode,
            maskGroup: preset.maskGroup,
            enabled: true
          })
        });
        const data = await res.json();
        
        if (data.success) {
          showStatus('add-rule-status', `âœ“ "${preset.name}" å·²æ·»åŠ ï¼`, 'success');
          setTimeout(() => {
            document.getElementById('add-rule-status').classList.add('status-hidden');
            loadRules();
          }, 1500);
        } else {
          showStatus('add-rule-status', 'å¤±è´¥: ' + data.message, 'error');
        }
      } catch (err) {
        showStatus('add-rule-status', 'é”™è¯¯: ' + err.message, 'error');
      }
    }
    
    // æ·»åŠ è‡ªå®šä¹‰è§„åˆ™
    async function addCustomRule() {
      const name = document.getElementById('rule-name').value.trim();
      if (!name) {
        showStatus('add-rule-status', 'è¯·å¡«å†™è§„åˆ™åç§°', 'error');
        return;
      }
      
      const template = document.getElementById('rule-template').value;
      let pattern, maskGroup;
      
      if (template === 'keyword') {
        // å…³é”®å­—æ¨¡å¼ï¼šè½¬æ¢ä¸ºæ­£åˆ™
        const keywords = document.getElementById('rule-keywords').value.trim();
        if (!keywords) {
          showStatus('add-rule-status', 'è¯·è¾“å…¥å…³é”®å­—', 'error');
          return;
        }
        
        // æ„å»ºæ­£åˆ™ï¼š(å…³é”®å­—1|å…³é”®å­—2)\s*[=:]+([^\s]+)
        const keywordList = keywords.split('|').map(k => k.trim()).filter(k => k);
        pattern = `(${keywordList.join('|')})\\s*[=:\\s]+([^\\s\\r\\n]+)`;
        maskGroup = 2; // è‡ªåŠ¨è®¾ä¸ºæ©ç›–å€¼éƒ¨åˆ†
      } else {
        // æ­£åˆ™æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨
        pattern = document.getElementById('rule-pattern').value.trim();
        if (!pattern) {
          showStatus('add-rule-status', 'è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼', 'error');
          return;
        }
        maskGroup = parseInt(document.getElementById('rule-target').value) || 0;
      }
      
      const maskMode = document.getElementById('rule-maskMode').value;
      const enabled = document.getElementById('rule-enabled').checked;
      
      showStatus('add-rule-status', 'æ·»åŠ ä¸­...', 'loading');
      try {
        const res = await fetch(`${API_BASE}/api/rules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            pattern: pattern,
            action: 'mask',
            maskMode: maskMode,
            maskGroup: maskGroup,
            enabled: enabled
          })
        });
        const data = await res.json();
        
        if (data.success) {
          showStatus('add-rule-status', 'âœ“ è§„åˆ™å·²æ·»åŠ ï¼', 'success');
          document.getElementById('rule-name').value = '';
          document.getElementById('rule-template').value = '';
          document.getElementById('rule-keywords').value = '';
          document.getElementById('rule-pattern').value = '';
          document.getElementById('rule-target').value = '0';
          document.getElementById('rule-maskMode').value = 'strong';
          document.getElementById('rule-enabled').checked = true;
          document.getElementById('keyword-mode').style.display = 'none';
          document.getElementById('regex-mode').style.display = 'block';
          
          setTimeout(() => {
            document.getElementById('add-rule-status').classList.add('status-hidden');
            loadRules();
          }, 1500);
        } else {
          showStatus('add-rule-status', 'å¤±è´¥: ' + data.message, 'error');
        }
      } catch (err) {
        showStatus('add-rule-status', 'é”™è¯¯: ' + err.message, 'error');
      }
    }
    
    // æ—§çš„ addRule å‡½æ•°ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    async function addRule() {
      // å¦‚æœæœ‰æ¨¡æ¿é€‰æ‹©ï¼Œä½¿ç”¨æ–°é€»è¾‘ï¼›å¦åˆ™ä½¿ç”¨æ—§é€»è¾‘
      const template = document.getElementById('rule-template')?.value;
      if (template || template === '') {
        addCustomRule();
      } else {
        // æ—§æ–¹å¼ï¼šç›´æ¥ä»è¾“å…¥æ¡†è¯»å–
        const name = document.getElementById('rule-name').value.trim();
        const pattern = document.getElementById('rule-pattern').value.trim();
        const maskMode = document.getElementById('rule-maskMode').value;
        const maskGroup = parseInt(document.getElementById('rule-maskGroup')?.value) || 0;
        const enabled = document.getElementById('rule-enabled').checked;
        
        if (!name || !pattern) {
          showStatus('add-rule-status', 'è¯·å¡«å†™è§„åˆ™åç§°å’ŒåŒ¹é…æ¨¡å¼', 'error');
          return;
        }
        
        showStatus('add-rule-status', 'æ·»åŠ ä¸­...', 'loading');
        try {
          const res = await fetch(`${API_BASE}/api/rules`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, pattern, action: 'mask', maskMode, maskGroup, enabled })
          });
          const data = await res.json();
          
          if (data.success) {
            showStatus('add-rule-status', 'è§„åˆ™æ·»åŠ æˆåŠŸï¼', 'success');
            document.getElementById('rule-name').value = '';
            document.getElementById('rule-pattern').value = '';
            document.getElementById('rule-maskGroup').value = '0';
            loadRules();
          } else {
            showStatus('add-rule-status', 'å¤±è´¥: ' + data.message, 'error');
          }
        } catch (err) {
          showStatus('add-rule-status', 'é”™è¯¯: ' + err.message, 'error');
        }
      }
    }

    // åˆ‡æ¢è§„åˆ™çŠ¶æ€
    async function toggleRule(ruleId, enabled) {
      try {
        const res = await fetch(`${API_BASE}/api/rules/${ruleId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        const data = await res.json();
        
        if (data.success) {
          loadRules();
        }
      } catch (err) {
        alert('æ“ä½œå¤±è´¥: ' + err.message);
      }
    }

    // åˆ é™¤è§„åˆ™
    async function deleteRule(ruleId) {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤è§„åˆ™ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/rules/${ruleId}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          loadRules();
        }
      } catch (err) {
        alert('åˆ é™¤å¤±è´¥: ' + err.message);
      }
    }

    // æµ‹è¯•è§„åˆ™
    async function testRule() {
      const command = document.getElementById('test-command').value.trim();
      const ruleId = document.getElementById('test-rule-id').value;
      
      if (!command || !ruleId) {
        showStatus('test-result', 'è¯·è¾“å…¥å‘½ä»¤å¹¶é€‰æ‹©è§„åˆ™', 'error');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/rules/test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command, ruleId })
        });
        const data = await res.json();
        
        if (data.success) {
          const result = data.result;
          if (result.error) {
            showStatus('test-result', 'æµ‹è¯•å¤±è´¥: ' + result.error, 'error');
          } else {
            const msg = result.matched 
              ? `âœ“ åŒ¹é…æˆåŠŸ\nåŠ¨ä½œ: ${result.action}\nç»“æœ: ${result.result}`
              : 'âœ— ä¸åŒ¹é…æ­¤è§„åˆ™';
            showStatus('test-result', msg, result.matched ? 'success' : 'warning');
          }
        }
      } catch (err) {
        showStatus('test-result', 'é”™è¯¯: ' + err.message, 'error');
      }
    }

    // åŠ è½½å¿«æ·æŒ‡ä»¤
    async function loadShortcuts() {
      try {
        const [shortcutsRes, categoriesRes] = await Promise.all([
          fetch(`${API_BASE}/api/shortcuts`),
          fetch(`${API_BASE}/api/shortcuts/categories`)
        ]);
        
        const shortcutsData = await shortcutsRes.json();
        const categoriesData = await categoriesRes.json();
        
        if (shortcutsData.success) {
          shortcuts = shortcutsData.shortcuts;
          renderShortcuts(shortcuts);
        }
        
        if (categoriesData.success) {
          categories = categoriesData.categories;
          const filterSelect = document.getElementById('shortcut-filter');
          filterSelect.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>' +
            categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }
      } catch (err) {
        console.error('åŠ è½½å¿«æ·æŒ‡ä»¤å¤±è´¥:', err);
      }
    }

    function renderShortcuts(list) {
      const listDiv = document.getElementById('shortcuts-list');
      if (list.length === 0) {
        listDiv.innerHTML = '<div class="empty">æ— åŒ¹é…ç»“æœ</div>';
      } else {
        listDiv.innerHTML = list.map(s => `
          <div class="shortcut-item">
            <div class="shortcut-header">
              <span class="shortcut-category">${escapeHtml(s.category)}</span>
            </div>
            <div class="shortcut-command-large"><code>${escapeHtml(s.command)}</code></div>
            <div class="shortcut-description">${escapeHtml(s.description || '')}</div>
            <div class="shortcut-meta">
              æ·»åŠ äº: ${new Date(s.addedAt).toLocaleString('zh-CN')}
            </div>
            <div class="shortcut-actions">
              <button onclick="copyToClipboard('${escapeAttr(s.command)}')" class="btn-sm">ğŸ“‹ å¤åˆ¶</button>
              <button onclick="deleteShortcut('${escapeAttr(s.id)}')" class="btn-sm btn-danger">åˆ é™¤</button>
            </div>
          </div>
        `).join('');
      }
    }

    // æ·»åŠ å¿«æ·æŒ‡ä»¤
    async function addShortcut() {
      const command = document.getElementById('shortcut-command').value.trim();
      const category = document.getElementById('shortcut-category').value.trim() || 'custom';
      const description = document.getElementById('shortcut-description').value.trim();
      
      if (!command) {
        showStatus('add-shortcut-status', 'è¯·è¾“å…¥PowerShellæŒ‡ä»¤', 'error');
        return;
      }
      
      showStatus('add-shortcut-status', 'æ·»åŠ ä¸­...', 'loading');
      try {
        const res = await fetch(`${API_BASE}/api/shortcuts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command, category, description })
        });
        const data = await res.json();
        
        if (data.success) {
          showStatus('add-shortcut-status', 'âœ“ å¿«æ·æŒ‡ä»¤å·²æ·»åŠ åˆ°PowerShellå†å²ï¼ä¸‹æ¬¡å°±å¯ä»¥ç”¨Tabè¡¥å…¨ã€‚', 'success');
          document.getElementById('shortcut-command').value = '';
          document.getElementById('shortcut-category').value = '';
          document.getElementById('shortcut-description').value = '';
          await loadShortcuts();
        } else {
          showStatus('add-shortcut-status', 'å¤±è´¥: ' + data.message, 'error');
        }
      } catch (err) {
        showStatus('add-shortcut-status', 'é”™è¯¯: ' + err.message, 'error');
      }
    }

    // åˆ é™¤å¿«æ·æŒ‡ä»¤
    async function deleteShortcut(id) {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤å¿«æ·æŒ‡ä»¤ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/shortcuts/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          loadShortcuts();
        }
      } catch (err) {
        alert('åˆ é™¤å¤±è´¥: ' + err.message);
      }
    }

    // æœç´¢å¿«æ·æŒ‡ä»¤
    function searchShortcuts() {
      const query = document.getElementById('shortcut-search').value.toLowerCase();
      const filtered = shortcuts.filter(s =>
        s.command.toLowerCase().includes(query) ||
        (s.description && s.description.toLowerCase().includes(query))
      );
      renderShortcuts(filtered);
    }

    // æŒ‰åˆ†ç±»è¿‡æ»¤
    function filterShortcuts() {
      const category = document.getElementById('shortcut-filter').value;
      const filtered = category ? shortcuts.filter(s => s.category === category) : shortcuts;
      renderShortcuts(filtered);
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      }).catch(err => {
        alert('å¤åˆ¶å¤±è´¥: ' + err.message);
      });
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(elemId, msg, status) {
      const elem = document.getElementById(elemId);
      elem.textContent = msg;
      elem.classList.remove('status-hidden', 'success', 'error', 'warning', 'loading');
      elem.classList.add(status);
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(s) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(s).replace(/[&<>"']/g, c => map[c]);
    }

    function escapeAttr(s) {
      return String(s).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
    }

    // åˆå§‹åŒ–
    (async () => {
      await loadStats();
    })();
  </script>
</body>
</html>
